name: CD - Production Deploy

on:
  workflow_run:
    workflows: ["SaffronAndSpiceWebCiPipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch: # Still allows you to trigger it manually

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  deploy:
    # Only run if CI succeeded or manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: windows-latest
    
    # This is the "Magic" line that triggers the manual approval gate
    environment: production 
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Install .NET 9 Hosting Bundle
        shell: pwsh
        run: |
          # Define the installation script
          $installScript = @"
            $ErrorActionPreference = 'Stop'
            Write-Output '--- [START] INSTALLING .NET 9 RUNTIME ---'

            # 1. Define Paths
            `$url = 'https://aka.ms/dotnet/9.0/dotnet-hosting-win.exe'
            `$output = 'C:\temp\dotnet-hosting.exe'
            
            # 2. Check if already installed
            try {
                `$current = dotnet --info
                if (`$current -match 'Microsoft.AspNetCore.App 9.') {
                    Write-Output 'SKIPPING: .NET 9 is already installed.'
                    exit 0
                }
            } catch {
                Write-Output 'STATUS: No existing dotnet found. Proceeding with install.'
            }

            # 3. Download (With Verbose Output)
            if (!(Test-Path 'C:\temp')) { New-Item -ItemType Directory -Force -Path 'C:\temp' | Out-Null }
            Write-Output "DOWNLOADING: `$url"
            Invoke-WebRequest -Uri `$url -OutFile `$output -UseBasicParsing
            
            # 4. Install Silently
            Write-Output 'INSTALLING: Running silent installer...'
            `$process = Start-Process -FilePath `$output -ArgumentList '/install', '/quiet', '/norestart' -Wait -PassThru
            
            if (`$process.ExitCode -eq 0 -or `$process.ExitCode -eq 3010) {
                Write-Output "SUCCESS: Installer finished with code `$(`$process.ExitCode)."
            } else {
                Write-Error "FAILURE: Installer failed with code `$(`$process.ExitCode)."
                exit 1
            }

            # 5. Restart IIS (Critical for loading the module)
            Write-Output 'RESTARTING: IIS World Wide Web Publishing Service...'
            net stop w3svc
            net start w3svc

            # 6. Final Verification
            Write-Output '--- [VERIFICATION] ---'
            dotnet --info
            Write-Output '--- [END] ---'
          "@

          # Write to file to avoid quoting issues
          Set-Content -Path "install_dotnet.ps1" -Value $installScript

          # Execute on VM
          az vm run-command invoke `
            --resource-group SaffronRestaurant-RG `
            --name Saffron-VM `
            --command-id RunPowerShellScript `
            --scripts "@install_dotnet.ps1"

      - name: Deploy to Azure VM
        run: |
        
          # 1. Capture variables
          $runnerRunId = "${{ github.event.workflow_run.id || github.event.inputs.manual_run_id }}"
          $runnerToken = "${{ secrets.GITHUB_TOKEN }}"
          
          # 2. Define the script content
          # FIX: Added -UseBasicParsing to all web requests
          $scriptContent = @"
            # --- BAKED IN VALUES ---
            `$RunId = "$runnerRunId"
            `$Token = "$runnerToken"
            
            Write-Output "DEBUG: Script started."
            Write-Output "DEBUG: Using RunID: `$RunId"
            
            if ([string]::IsNullOrWhiteSpace(`$RunId)) {
                Write-Error "CRITICAL: RunID is empty."
                exit 1
            }

            try {
                `$headers = @{ 
                    'Authorization' = 'Bearer ' + `$Token
                    'Accept'        = 'application/vnd.github+json'
                    'X-GitHub-Api-Version' = '2022-11-28'
                }

                `$apiUrl = "https://api.github.com/repos/${{ github.repository }}/actions/runs/`$RunId/artifacts"
                Write-Output "DEBUG: Fetching URL: `$apiUrl"

                # FIX 1: Added -UseBasicParsing
                `$resp = Invoke-RestMethod -Uri `$apiUrl -Headers `$headers -UseBasicParsing -ErrorAction Stop
                
                `$artifact = `$resp.artifacts | Where-Object { `$_.name -like 'restaurant-app-*' } | Select-Object -First 1
                
                if (!`$artifact) { throw "Artifact not found for Run ID `$RunId" }

                `$downloadUrl = `$artifact.archive_download_url
                
                # FIX 2: Added -UseBasicParsing
                `$redirect = Invoke-WebRequest -Uri `$downloadUrl -Headers `$headers -MaximumRedirection 0 -UseBasicParsing -ErrorAction SilentlyContinue
                `$finalUrl = `$redirect.Headers.Location
                if (!`$finalUrl) { `$finalUrl = `$downloadUrl }

                Write-Output "DEBUG: Downloading zip..."
                # FIX 3: Added -UseBasicParsing
                Invoke-WebRequest -Uri `$finalUrl -OutFile 'C:/temp/app.zip' -UseBasicParsing

                Write-Output "DEBUG: Deploying..."
                Stop-Service w3svc
                Remove-Item 'C:/inetpub/wwwroot/*' -Recurse -Force -ErrorAction SilentlyContinue
                Expand-Archive -Path 'C:/temp/app.zip' -DestinationPath 'C:/inetpub/wwwroot' -Force
                Start-Service w3svc
                
                Write-Output "SUCCESS: Deployment Complete."
            }
            catch {
                Write-Error "CRITICAL FAILURE: `$_"
                exit 1
            }
          "@
          
          # 3. Save and Send
          Set-Content -Path "deploy.ps1" -Value $scriptContent
          
          az vm run-command invoke `
            --resource-group SaffronRestaurant-RG `
            --name Saffron-VM `
            --command-id RunPowerShellScript `
            --scripts "@deploy.ps1"
