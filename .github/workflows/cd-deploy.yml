name: CD - Production Deploy

on:
  workflow_run:
    workflows: ["SaffronAndSpiceWebCiPipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch: # Still allows you to trigger it manually

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    # Only run if CI succeeded or manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: windows-latest
    
    # This is the "Magic" line that triggers the manual approval gate
    environment: production 
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure VM
        run: |
          # Use the Run ID from the CI trigger or the manual input
          $RUN_ID= "${{ github.event.workflow_run.id || github.event.inputs.manual_run_id }}"
          TOKEN= "${{ secrets.GITHUB_TOKEN }}"
          az vm run-command invoke `
            --resource-group SaffronRestaurant-RG `
            --name Saffron-VM `
            --command-id RunPowerShellScript `
            --scripts "
              # A. Setup headers with the temporary GitHub Token
              $headers = @{ 
                'Authorization' = 'Bearer $TOKEN'; 
                'Accept' = 'application/vnd.github+json';
                'X-GitHub-Api-Version' = '2022-11-28'
              }
              
              # B. Query GitHub API for the Artifact download URL
              $apiUrl = 'https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts'
              $resp = Invoke-RestMethod -Uri $apiUrl -Headers $headers
              
              # C. Find our specific restaurant app zip
              $dlUrl = $resp.artifacts | Where-Object { \$_.name -like 'restaurant-app-*' } | Select-Object -ExpandProperty download_url
              
              # D. Download and extract directly to IIS
              Invoke-WebRequest -Uri \$dlUrl -Headers $headers -OutFile 'app.zip'
              Expand-Archive -Path 'app.zip' -DestinationPath 'C:/inetpub/wwwroot' -Force
              
              iisreset
            "
